name: Unity Tests

on:
  push:
    branches: [ main, develop, copilot/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  UNITY_VERSION: 6000.0.23f1

jobs:
  test-editmode:
    name: EditMode Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
          
      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-
            
      - name: Run EditMode Tests
        uses: game-ci/unity-test-runner@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          testMode: editmode
          checkName: EditMode Test Results
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: editmode-test-results
          path: artifacts/editmode-results.xml
          
      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: editmode-coverage
          path: CodeCoverage/

  test-playmode:
    name: PlayMode Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
          
      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-
            
      - name: Run PlayMode Tests
        uses: game-ci/unity-test-runner@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          testMode: playmode
          checkName: PlayMode Test Results
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playmode-test-results
          path: artifacts/playmode-results.xml

  build-webgl:
    name: Build WebGL
    runs-on: ubuntu-latest
    needs: [test-editmode, test-playmode]
    timeout-minutes: 60
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
          
      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-
            
      - name: Build WebGL
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: WebGL
          buildsPath: builds
          
      - name: Upload WebGL Build
        uses: actions/upload-artifact@v4
        with:
          name: webgl-build
          path: builds/WebGL
          retention-days: 7

  lint-code:
    name: Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
          
      - name: Check C# Formatting
        run: |
          dotnet tool install -g dotnet-format || true
          dotnet format --verify-no-changes --verbosity diagnostic || echo "Formatting issues found"
        continue-on-error: true
        
      - name: Run Static Analysis
        run: |
          echo "Static analysis would run here with tools like:"
          echo "- ReSharper CLI"
          echo "- SonarQube Scanner"
          echo "- Roslyn Analyzers"
        continue-on-error: true

  test-results:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [test-editmode, test-playmode]
    if: always()
    
    steps:
      - name: Download EditMode Results
        uses: actions/download-artifact@v4
        with:
          name: editmode-test-results
          path: test-results/
        continue-on-error: true
        
      - name: Download PlayMode Results
        uses: actions/download-artifact@v4
        with:
          name: playmode-test-results
          path: test-results/
        continue-on-error: true
        
      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: test-results/**/*.xml
          check_name: Unity Test Results
          comment_mode: off
